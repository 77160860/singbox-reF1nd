name: Build Mini sing-box Core

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'sing-box source (tag/branch/commit)'
        type: string
        required: false
        default: 'reF1nd-main'
      build_version:
        description: 'Version string to embed (constant.Version) [required]'
        type: string
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Prepare context
        id: prep
        run: |
          UPSTREAM_REPO="https://github.com/reF1nd/sing-box.git"
          REF="${{ github.event.inputs.version }}"
          VERSION="${{ github.event.inputs.build_version }}"

          echo "REF=$REF" >> $GITHUB_ENV
          echo "UPSTREAM_REPO=$UPSTREAM_REPO" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "ref=$REF" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "upstream=$UPSTREAM_REPO" >> $GITHUB_OUTPUT

      - name: Resolve SHA (tag/branch/commit)
        id: upstream
        run: |
          set -e
          SHA=$(git ls-remote --heads "${UPSTREAM_REPO}" "refs/heads/${REF}" | cut -f1)
          if [ -z "$SHA" ]; then
            SHA=$(git ls-remote --tags "${UPSTREAM_REPO}" "${REF}^{}" | cut -f1)
          fi
          if [ -z "$SHA" ]; then
            SHA=$(git ls-remote "${UPSTREAM_REPO}" "${REF}" | cut -f1)
          fi
          if [ -z "$SHA" ]; then
            echo "ERROR: REF '${REF}' not found (branch/tag/commit)."
            exit 1
          fi
          SHORT="${SHA:0:7}"
          echo "UPSTREAM_SHA=$SHA" >> $GITHUB_ENV
          echo "SHORT_SHA=$SHORT" >> $GITHUB_ENV
          echo "sha=$SHA" >> $GITHUB_OUTPUT
          echo "short=$SHORT" >> $GITHUB_OUTPUT

      - name: Checkout upstream
        uses: actions/checkout@v4
        with:
          repository: reF1nd/sing-box
          ref: ${{ steps.upstream.outputs.sha }}
          fetch-depth: 1

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Define build metadata
        id: meta
        run: |
          # Tags per-OS
          TAGS_LINUX="with_quic with_utls with_gvisor with_clash_api"
          TAGS_WIN64="with_quic with_utls with_gvisor with_clash_api with_purego"

          # linux/arm64
          OUT_LINUX="sing-box-linux-arm64-${VERSION}-${SHORT_SHA}"
          ZIP_LINUX="${OUT_LINUX}.zip"

          # windows/amd64
          OUT_WIN64="sing-box-windows-amd64-${VERSION}-${SHORT_SHA}.exe"
          ZIP_WIN64="sing-box-windows-amd64-${VERSION}-${SHORT_SHA}.zip"

          TAG="sing-box-${VERSION}-${SHORT_SHA}"

          echo "TAGS_LINUX=$TAGS_LINUX" >> $GITHUB_ENV
          echo "TAGS_WIN64=$TAGS_WIN64" >> $GITHUB_ENV
          echo "OUT_LINUX=$OUT_LINUX" >> $GITHUB_ENV
          echo "ZIP_LINUX=$ZIP_LINUX" >> $GITHUB_ENV
          echo "OUT_WIN64=$OUT_WIN64" >> $GITHUB_ENV
          echo "ZIP_WIN64=$ZIP_WIN64" >> $GITHUB_ENV
          echo "TAG=$TAG" >> $GITHUB_ENV

          echo "tags_linux=$TAGS_LINUX" >> $GITHUB_OUTPUT
          echo "tags_win64=$TAGS_WIN64" >> $GITHUB_OUTPUT
          echo "out_linux=$OUT_LINUX" >> $GITHUB_OUTPUT
          echo "zip_linux=$ZIP_LINUX" >> $GITHUB_OUTPUT
          echo "out_win64=$OUT_WIN64" >> $GITHUB_OUTPUT
          echo "zip_win64=$ZIP_WIN64" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Build sing-box (linux arm64 minimal)
        env:
          GOOS: linux
          GOARCH: arm64
        run: |
          go build \
            -trimpath \
            -o "${OUT_LINUX}" \
            -ldflags="-s -w -X github.com/sagernet/sing-box/constant.Version=${VERSION}" \
            -tags="${TAGS_LINUX}" \
            ./cmd/sing-box

      - name: Build sing-box (windows amd64 minimal)
        env:
          CGO_ENABLED: "0" # Windows 必须禁用 CGO
          GOOS: windows
          GOARCH: amd64
        run: |
          go build \
            -trimpath \
            -o "${OUT_WIN64}" \
            -ldflags="-s -w -X github.com/sagernet/sing-box/constant.Version=${VERSION}" \
            -tags="${TAGS_WIN64}" \
            ./cmd/sing-box

      - name: Verify arch
        run: |
          file "${OUT_LINUX}" || true
          file "${OUT_WIN64}" || true
          ls -lh "${OUT_LINUX}" "${OUT_WIN64}"

      - name: Package zip (linux)
        run: |
          set -euo pipefail
          test -f "${OUT_LINUX}"
          cp -f "${OUT_LINUX}" sing-box
          zip -9 -j "${ZIP_LINUX}" sing-box
          ls -lh "${ZIP_LINUX}"
          rm -f sing-box

      - name: Package zip (windows amd64)
        run: |
          set -euo pipefail
          test -f "${OUT_WIN64}"
          cp -f "${OUT_WIN64}" sing-box.exe
          zip -9 -j "${ZIP_WIN64}" sing-box.exe
          ls -lh "${ZIP_WIN64}"
          rm -f sing-box.exe

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: sing-box-minimal-arm64-${{ steps.upstream.outputs.short }}
          path: |
            ${{ steps.meta.outputs.zip_linux }}
            ${{ steps.meta.outputs.zip_win64 }}

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          name: sing-box minimal (${{ steps.upstream.outputs.short }})
          body: |
            Source: reF1nd/sing-box @ ${{ env.VERSION }}
            GOOS/GOARCH: linux/arm64, windows/amd64
            Tags:
              linux: ${{ steps.meta.outputs.tags_linux }}
              windows: ${{ steps.meta.outputs.tags_win64 }}
          prerelease: true
          files: |
            ${{ steps.meta.outputs.zip_linux }}
            ${{ steps.meta.outputs.zip_win64 }}
